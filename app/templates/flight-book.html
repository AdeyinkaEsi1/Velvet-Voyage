{% extends "base.html" %}

{% block title %}Flights - Horizon Travels{% endblock %}

{% block content %}


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/flight-book.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
</head>


<main>
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo">
                <img src="{{ url_for('static', filename='images/brand-logo.webp') }}" alt="HT Travels Logo"
                    class="logo-img">
                <span class="logo-text">HT Travels</span>
            </a>
            <nav class="nav">
                <ul class="nav-list">
                    <li><a href="" class="nav-link active">Home</a></li>
                    <li><a href="#" class="nav-link">Flights</a></li>
                    <li><a href="#" class="nav-link">About Us</a></li>
                    <li><a href="#" class="nav-link">Contact</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <a href="{{ url_for('auth.login') }}" class="sign-in">Sign In</a>
                <a href="{{ url_for('auth.register') }}" class="register">Register</a>
                <button class="menu-toggle">
                    <i class="fa fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <section class="flight-review">
        <div class="flight-review">
            <div class="book-container">
                <h2>Flight Booking Review</h2>

                <div class="booking-container">
                    <div class="booking-card">

                        <h2>Booking Details</h2>
                        {% if booking %}
                        <table>
                            <tr>
                                <td><strong>User ID:</strong></td>
                                <td id="userId">{{ booking.user_id }}</td>
                            </tr>
                            <tr>
                                <td><strong>Flight ID:</strong></td>
                                <td id="flightId">{{ booking.flight_id }}</td>
                            </tr>
                            <tr>
                                <td><strong>Departure:</strong></td>
                                <td id="departure">{{ booking.departure }}</td>
                            </tr>
                            <tr>
                                <td><strong>Destination:</strong></td>
                                <td id="destination">{{ booking.destination }}</td>
                            </tr>
                            <tr>
                                <td><strong>Departure Date:</strong></td>
                                <td id="departureDate">{{ booking.departure_date }}</td>
                            </tr>
                            <tr>
                                <td><strong>Departure Time:</strong></td>
                                <td id="departureTime">{{ booking.departure_time }}</td>
                            </tr>
                            <tr>
                                <td><strong>Arrival Time:</strong></td>
                                <td id="arrivalTime">{{ booking.arrival_time }}</td>
                            </tr>
                            <tr>
                                <td><strong>Return Date:</strong></td>
                                <td id="returnDate">{{ booking.return_date }}</td>
                            </tr>
                            <tr>
                                <td><strong>Seats:</strong></td>
                                <td id="seats">{{ booking.seats }}</td>
                            </tr>
                            <tr>
                                <td><strong>Flight Class:</strong></td>
                                <td id="flightClass">{{ booking.flight_class }}</td>
                            </tr>
                            <tr>
                                <td><strong>Round Trip:</strong></td>
                                <td id="roundTrip">{{ "Yes" if booking.round_trip else "No" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Base Price (Per Seat):</strong></td>
                                <td id="basePrice">${{ booking.base_price }}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Price (Before Discount):</strong></td>
                                <td id="totalPrice">${{ booking.total_price}} ({{ booking.base_price }} x {{ booking.seats }} seats)</td>
                            </tr>
                            <tr>
                                <td><strong>Discount Applied:</strong></td>
                                <td id="discountApplied">${{ booking.discount_applied }}</td>
                            </tr>
                            <tr>
                                <td><strong>Final Price (After Discount)</strong></td>
                                <td id="finalPrice">${{ booking.final_price }}</td>
                            </tr>
                        </table>
                        {% else %}
                        <p>No bookings found.</p>
                        {% endif %}
                    </div>
                    <button style="margin-top: 30px;" type="button" class="proceed-btn" id="proceedToPayment">
                        Proceed to Payment
                    </button>

                </div>
    </section>


    <script>
        document.getElementById('proceedToPayment').addEventListener('click', async function () {
            const bookingDetails = {
                flight_id: "{{ booking.flight_id }}",
                seats: "{{ booking.seats }}",
                flight_class: "{{ booking.flight_class }}",
                round_trip: "{{ booking.round_trip }}",
                base_price: "{{ booking.total_price }}",
                discount: "{{ booking.discount_applied }}",
                final_price: "{{ booking.total_price - booking.discount_applied }}"
            };

            try {
                const response = await fetch('/bookings/confirm_booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token_cookie')}`
                    },
                    body: JSON.stringify(bookingDetails)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || "Failed to confirm booking");
                }

                // Redirect to the payment page with the booking ID
                const bookingId = result.booking_id;
                window.location.href = `/payment/${bookingId}`;
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

    </script>
</main>

<!-- Footer Section -->
<footer class="footer">
    <div class="container">
        <div class="footer-grid">
            <!-- Company Info -->
            <div class="footer-section">
                <div class="logo">
                    <img src="{{ url_for('static', filename='images/brand-logo.webp') }}" alt="HT Travels Logo">
                    <span>HT Travels</span>
                </div>
                <p>Your trusted partner for flights, hotels, and vacation packages worldwide.</p>
                <div class="social-icons">
                    <a href="#" class="icon facebook"><i class="fa-brands fa-facebook"></i></a>
                    <a href="#" class="icon instagram"><i class="fa-brands fa-instagram"></i></a>
                    <a href="#" class="icon twitter"><i class="fa-brands fa-twitter"></i></a>
                    <a href="#" class="icon linkedin"><i class="fa-brands fa-linkedin"></i></a>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#">Home</a></li>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Flights</a></li>
                    <li><a href="#">Hotels</a></li>
                    <li><a href="#">Vacation Packages</a></li>
                    <li><a href="#">Travel Insurance</a></li>
                </ul>
            </div>

            <!-- Support -->
            <div class="footer-section">
                <h3>Support</h3>
                <ul>
                    <li><a href="#">FAQs</a></li>
                    <li><a href="#">Contact Us</a></li>
                    <li><a href="#">Booking Terms</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Refund Policy</a></li>
                    <li><a href="#">COVID-19 Travel Info</a></li>
                </ul>
            </div>

            <!-- Contact Info -->
            <div class="footer-section">
                <h3>Contact Us</h3>
                <p>123 Travel Street, Suite 100<br>Edinburgh, ED 10001</p>
                <p>Phone: +1 (555) 123-4567</p>
                <p>Email: info@httravels.com</p>
            </div>
        </div>

        <div class="footer-bottom">
            <p>© 2025 HT Travels. All rights reserved.</p>
        </div>
    </div>
</footer>

{% endblock %}